(function(m){"use strict";$('<style type="text/css">'+"#nf-coaches svg { pointer-events: none; }"+"#flashPageDiv, object, .loadflash, .infoBoxCoachMap { display: none }"+'#ResEnq_0_true:after { content: " ❤"}'+".boxy-inner.nf-boxy { background: #ddd}"+"#nf-loader-prev, #nf-loader-next { margin: 20px auto; display: block; }"+"#nf-coaches svg { padding: 0 1.5em 20px; width: 800px; }"+"#nf-coaches>div { background: #fff; border-radius: 5px; margin: 10px; width:830px }"+"#nf-coaches h2 { font: bold 24px Arial; padding: 20px 10px 0 30px; margin: 0; }"+"#nf-coaches h2 span { font: normal 16px Arial; font-style: italic; color: #555; padding-left: 1em; }"+"#nf-buttons { padding: 0 10px 35px 6px; }"+"#nf-buttons span.btnGreen { float:right; }"+"</style>").appendTo("head");var y=$('script[src*="/nf.js"], script[src*="/nf.min.js"]').attr("src").replace(/nf\.(min\.)?js.*/,"");var E={A40:true,CEMT:true,CHFY:true,CM:true,CMH:true,ED:true,EDB:true,EDB12:true,EDB2:true,EDFS:true,EDILX:true,EDM:true,EDO:true,EDS:true,EFIT:true,EFIT2:true,EFITI:true,EFITIL:true,EFITL:true,EHF:true,EHFL:true,EI:true,EI2:true,EI2L:true,EIL:true,EILF:true,EIN:true,EINY:true,EIP:true,EIPT:true,EIPT2:true,ERD:true,EX:true,EXPT:true,EXPT2:true,EXY:true,IM1:true,IM2:true,IM2L:true,MC1A:true,MC2A:true,MH2A:true,MP2A:true,MP2L:true,RIC1:true,RIC2:true,TT:true,TTP2A:true,TTPS2A:true,VCM:true,VEI:true,VEM:true,VEM8:true,VEMIV:true,VIP:true,VIPB:true};var x={};m.console=m.console||{};console.log=console.log||function(){};m.loadFlash=function(){var l={};var s={};var i;var u=parseInt($("#noOfPassengers").val());var c=[];var r=[];var f=0;function o(){var a={prev:false,next:false};$.each(s,function(e,t){if(t===1){a[e.substr(0,4)]=true}});$("#nf-loader-prev").toggle(a.prev);$("#nf-loader-next").toggle(a.next)}function p(t,a){var n=parseInt($("#coachNo",t).val());if(isNaN(n)){return}["prev","next"].forEach(function(r){if(a&&a!=r){return}if($("#"+r+"CoachAvailable",t).val()==="true"&&!(s[r+n]||l[n+(r==="prev"?-1:1)]||s[r+n+(r==="prev"?-2:2)])){s[r+n]=1;var e=$("#seatMapForm").clone();e.find("#coachNo").val(n);e.ajaxSubmit({url:"Reservation_"+r+".do",success:function(e){s[r+n]=2;var t=(new DOMParser).parseFromString(e,"text/html");var a=$("#coachNo",t).val();if(a){d(t,r)}o()}})}});o()}function d(e,t){var a=$("#coachType",e).val();if(!a){console.log("no type?",e,$("#coachType",e));return}var r=$("#coachNo",e).val();var n=$("<div/>");n.attr("data-nf-coach-number",r);i.children().each(function(){if(parseInt($(this).attr("data-nf-coach-number"))>parseInt(r)){n.insertBefore(this);return false}});if(l[r]&&l[r].type){return}l[r]={$dstElem:n,number:r,type:a,title:$("input#coachDescription",e).val(),statusXML:$("input#coachXMLString",e).val()};p(e,t);h(l[r])}var v='<filter id="status-na">'+"</filter>"+'<filter id="status-free">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope=".32"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope=".32"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-taken">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="0"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-selected">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>";m.nfDefineCoach=function(e){x[e.type]=e.svg;n()};function n(){r=r.filter(function(e){if(x[e[0]]){e[1]();return false}else{return true}})}function h(e){var t=$("<h2/>").text("VAUNU "+e.number);t.append($("<span/>").text(e.title+" ("+e.type+")"));e.$dstElem.append(t);var a={IM1A:"IM1"};if(a[e.type]){e.type=a[e.type]}r.push([e.type,function(){g(e)}]);if(Object.keys(E).length&&!E[e.type]){alert("Vaunutyyppiä '"+e.type+"' ei löydy. :(")}if(x[e.type]){m.setTimeout(n,1)}else{$.ajaxSetup({cache:true});$.getScript(y+"coaches/"+e.type+".js");$.ajaxSetup({cache:false})}}function g(r){f++;r.svgId=f;var e=x[r.type].replace(/ width="\w+"/,"").replace(/ height="\w+"/,"").replace(/ id="(?=\w+")/g,' id="c'+r.svgId).replace(/ xlink:href="#(?=\w+")/g,' xlink:href="#c'+r.svgId);if(r.svgId===1){e=e.replace(/<defs>/,"<defs>"+v)}var t=(new DOMParser).parseFromString(e,"text/xml");var a=(new DOMParser).parseFromString(r.statusXML,"text/xml");r.statuses={};$("seat",a).each(function(){var e=$(this);var t=e.find("number").text();if(e.find("selected").text()==="1"){r.statuses[t]="selected";c.push({coach:r.number,seat:t})}else{var a=e.find("status").text();if(a==="0"){r.statuses[t]="free"}else{if(!/^[16]$/.test(a)){console.log("UNKNOWN SEAT STATUS",r.number,t,a)}r.statuses[t]="taken"}}});function n(e){var t;while(t=e.getAttribute("xlink:href")){e=$(t)[0]}$(e).find("*").andSelf().attr("fill","#fff")}t.children[0].id="nf-svg-"+r.svgId;r.$dstElem.append(t.children[0]);r.$dstElem.find("svg").hide().fadeIn();function s(e){return Array.prototype.slice.apply(document.querySelectorAll("svg#nf-svg-"+r.svgId+" "+e))}var i=s('[class="n-floorplan"]')[0];var o=s(i.getAttribute("xlink:href"))[0];o.setAttribute("transform",i.getAttribute("transform"));i.parentNode.removeChild(i);o.parentNode.removeChild(o);s("")[0].appendChild(o);r.drawSeatStatuses=function(e){var t=e?'[class="n-seat_'+e+'"]':'[class^="n-seat_"]';s(t).forEach(function(e){n(e);$(e.getAttribute("xlink:href")).css({cursor:"pointer",pointerEvents:"all"});var t=e.className.baseVal.replace(/^n-seat_/,"");if(t in r.statuses){e.setAttribute("filter","url(#status-"+r.statuses[t]+")")}})};r.drawSeatStatuses();s('[class^="n-seat_"]').forEach(function(e){$(e).click(function(){var e=this.className.baseVal.replace(/^n-seat_/,"");if(r.statuses[e]==="free"){c.push({coach:r.number,seat:e});r.statuses[e]="selected";if(c.length>u){var t=c.shift();l[t.coach].statuses[t.seat]="free";l[t.coach].drawSeatStatuses(t.seat)}r.drawSeatStatuses(e)}})})}i=$('<div id="nf-coaches"/>');i.append($("<div/>").attr("data-nf-coach-number",999));$("#flashPageDiv").after('<img id="nf-loader-prev" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">',i,'<img id="nf-loader-next" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">','<div id="nf-buttons">'+'<span class="btnVR middle btnGreen"><a href="#">Vahvista</a></span>'+'<span class="btnVR middle btnGrey"><a href="#">Peruuta</a></span>'+"</div>");$("#flashPageDiv").closest(".boxy-inner").addClass("nf-boxy");$("#nf-buttons a:first").click(function(){var e=u-c.length;if(e){alert("Valitse vielä "+e+" paikka"+(e>1?"a":""));return}var t=c[0].coach;var a="";c.forEach(function(e){if(t!==e.coach){alert("Valitettavasti tällä virityksellä voi varata paikkoja vain yhdestä vaunusta kerrallaan.");return}a+=",seat_"+e.seat});a=a.replace(/^,/,"");$("#seatMapForm #coachNo").val(t);saveSeatReservations("./Reservation_add.do",a)});$("#nf-buttons a:last").click(function(){$("a.close").trigger("click")});d(document)}})(this);
