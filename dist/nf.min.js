(function(y){"use strict";$('<style type="text/css">'+"#nf-coaches svg { pointer-events: none; }"+"#flashPageDiv, object, .loadflash, .infoBoxCoachMap { display: none }"+'#ResEnq_0_true:after { content: " ❤"}'+".boxy-inner.nf-boxy { background: #ddd}"+"#nf-loader-prev, #nf-loader-next { margin: 20px auto; display: block; }"+"#nf-coaches svg { padding: 0 1.5em 20px; width: 800px; }"+"#nf-coaches>div { background: #fff; border-radius: 5px; margin: 10px; width:830px }"+"#nf-coaches h2 { font: bold 24px Arial; padding: 20px 10px 0 30px; margin: 0; }"+"#nf-coaches h2 span { font: normal 16px Arial; font-style: italic; color: #555; padding-left: 1em; }"+"#nf-buttons { padding: 0 10px 35px 6px; }"+"#nf-buttons span.btnGreen { float:right; }"+"</style>").appendTo("head");var x=$('script[src*="/nf.js"], script[src*="/nf.min.js"]').attr("src").replace(/nf\.(min\.)?js.*/,"");var b={};var k={};y.console=y.console||{};console.log=console.log||function(){};y.loadFlash=function(){var l={};var s={};var i;var c=parseInt($("#noOfPassengers").val());var f=[];var r=[];var p=0;function o(){var a={prev:false,next:false};$.each(s,function(e,t){if(t===1){a[e.substr(0,4)]=true}});$("#nf-loader-prev").toggle(a.prev);$("#nf-loader-next").toggle(a.next)}function u(t,a){var r=parseInt($("#coachNo",t).val());if(isNaN(r)){return}["prev","next"].forEach(function(n){if(a&&a!=n){return}if($("#"+n+"CoachAvailable",t).val()==="true"&&!(s[n+r]||l[r+(n==="prev"?-1:1)]||s[n+r+(n==="prev"?-2:2)])){s[n+r]=1;var e=$("#seatMapForm").clone();e.find("#coachNo").val(r);e.ajaxSubmit({url:"Reservation_"+n+".do",success:function(e){s[n+r]=2;var t=(new DOMParser).parseFromString(e,"text/html");var a=$("#coachNo",t).val();if(a){d(t,n)}o()}})}});o()}function d(e,t){var a=$("#coachType",e).val();if(!a){console.log("no type?",e,$("#coachType",e));return}var n=$("#coachNo",e).val();var r=$("<div/>");r.attr("data-nf-coach-number",n);i.children().each(function(){if(parseInt($(this).attr("data-nf-coach-number"))>parseInt(n)){r.insertBefore(this);return false}});if(l[n]&&l[n].type){return}l[n]={$dstElem:r,number:n,type:a,title:$("input#coachDescription",e).val(),statusXML:$("input#coachXMLString",e).val()};u(e,t);g(l[n],$("input#selectedPlaceType",e).val())}var v='<filter id="status-na">'+"</filter>"+'<filter id="status-free">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope=".32"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope=".32"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-taken">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="0"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-selected">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>";y.nfDefineCoach=function(e){k[e.type]=e.svg;h()};function h(){r=r.filter(function(e){if(k[e[0]]){e[1]();return false}else{return true}})}function g(e,t){var a=$("<h2/>").text("VAUNU "+e.number);a.append($("<span/>").text(e.title+" ("+e.type+")"));e.$dstElem.append(a);if(t!=="SEAT"){e.$dstElem.append($("<span/>").text("HUOM! Makuupaikkojen valinta ei ehkä toimi oikein - verkkokauppa saattaa ehdottaa väärää hintaa.").css({color:"red",paddingLeft:"20px"}))}var n={IM1A:"IM1"};if(n[e.type]){e.type=n[e.type]}r.push([e.type,function(){m(e)}]);if(Object.keys(b).length&&!b[e.type]){alert("Vaunutyyppiä '"+e.type+"' ei löydy. :(")}if(k[e.type]){y.setTimeout(h,1)}else{$.ajaxSetup({cache:true});$.getScript(x+"coaches/"+e.type+".js");$.ajaxSetup({cache:false})}}function m(n){p++;n.svgId=p;var e=k[n.type].replace(/ width="\w+"/,"").replace(/ height="\w+"/,"").replace(/ id="(?=\w+")/g,' id="c'+n.svgId).replace(/ xlink:href="#(?=\w+")/g,' xlink:href="#c'+n.svgId);if(n.svgId===1){e=e.replace(/<defs>/,"<defs>"+v)}var t=(new DOMParser).parseFromString(e,"text/xml");var a=(new DOMParser).parseFromString(n.statusXML,"text/xml");n.statuses={};$("seat",a).each(function(){var e=$(this);var t=e.find("number").text();if(e.find("selected").text()==="1"){n.statuses[t]="selected";f.push({coach:n.number,seat:t})}else{var a=e.find("status").text();if(a==="0"){n.statuses[t]="free"}else{if(!/^[16]$/.test(a)){console.log("UNKNOWN SEAT STATUS",n.number,t,a)}n.statuses[t]="taken"}}});function r(e){var t;while(t=e.getAttribute("xlink:href")){e=$(t)[0]}$(e).find("*").andSelf().attr("fill","#fff")}t.children[0].id="nf-svg-"+n.svgId;n.$dstElem.append(t.children[0]);n.$dstElem.find("svg").hide().fadeIn();function s(e){return Array.prototype.slice.apply(document.querySelectorAll("svg#nf-svg-"+n.svgId+" "+e))}var i=s('[class="n-floorplan"]')[0];var o=s(i.getAttribute("xlink:href"))[0];o.setAttribute("transform",i.getAttribute("transform"));i.parentNode.removeChild(i);o.parentNode.removeChild(o);s("")[0].appendChild(o);n.drawSeatStatuses=function(e){var t=e?'[class="n-seat_'+e+'"]':'[class^="n-seat_"]';s(t).forEach(function(e){r(e);$(e.getAttribute("xlink:href")).css({cursor:"pointer",pointerEvents:"all"});var t=e.className.baseVal.replace(/^n-seat_/,"");if(t in n.statuses){e.setAttribute("filter","url(#status-"+n.statuses[t]+")")}})};n.drawSeatStatuses();s('[class^="n-seat_"]').forEach(function(e){$(e).click(function(){var e=this.className.baseVal.replace(/^n-seat_/,"");if(n.statuses[e]==="free"){f.push({coach:n.number,seat:e});n.statuses[e]="selected";if(f.length>c){var t=f.shift();l[t.coach].statuses[t.seat]="free";l[t.coach].drawSeatStatuses(t.seat)}n.drawSeatStatuses(e)}})})}i=$('<div id="nf-coaches"/>');i.append($("<div/>").attr("data-nf-coach-number",999));$("#flashPageDiv").after('<img id="nf-loader-prev" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">',i,'<img id="nf-loader-next" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">','<div id="nf-buttons">'+'<span class="btnVR middle btnGreen"><a href="#">Vahvista</a></span>'+'<span class="btnVR middle btnGrey"><a href="#">Peruuta</a></span>'+"</div>");$("#flashPageDiv").closest(".boxy-inner").addClass("nf-boxy");$("#nf-buttons a:first").click(function(){var e=c-f.length;if(e){alert("Valitse vielä "+e+" paikka"+(e>1?"a":""));return}var t=f[0].coach;var a="";f.forEach(function(e){if(t!==e.coach){alert("Valitettavasti tällä virityksellä voi varata paikkoja vain yhdestä vaunusta kerrallaan.");return}a+=",seat_"+e.seat});a=a.replace(/^,/,"");$("#seatMapForm #coachNo").val(t);saveSeatReservations("./Reservation_add.do",a)});$("#nf-buttons a:last").click(function(){$("a.close").trigger("click")});d(document)}})(this);
